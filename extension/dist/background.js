const x="SingularityDB";const c="facts",l="conversations";let f=null;async function w(){return new Promise((t,n)=>{const e=indexedDB.open(x,1);e.onerror=()=>n(e.error),e.onsuccess=()=>{f=e.result,t(f)},e.onupgradeneeded=o=>{const a=o.target.result;if(!a.objectStoreNames.contains(c)){const r=a.createObjectStore(c,{keyPath:"id",autoIncrement:!0});r.createIndex("platform","platform",{unique:!1}),r.createIndex("timestamp","timestamp",{unique:!1}),r.createIndex("category","category",{unique:!1})}if(!a.objectStoreNames.contains(l)){const r=a.createObjectStore(l,{keyPath:"id",autoIncrement:!0});r.createIndex("platform","platform",{unique:!1}),r.createIndex("timestamp","timestamp",{unique:!1})}}})}async function u(){return f||await w(),f}async function h(t){const n=await u();return new Promise((e,o)=>{const s=n.transaction([c],"readwrite").objectStore(c).add(t);s.onsuccess=()=>e(s.result),s.onerror=()=>o(s.error)})}async function S(t){const n=await u();return new Promise((e,o)=>{const s=n.transaction([l],"readwrite").objectStore(l).add(t);s.onsuccess=()=>e(s.result),s.onerror=()=>o(s.error)})}async function p(){const t=await u();return new Promise((n,e)=>{const r=t.transaction([c],"readonly").objectStore(c).getAll();r.onsuccess=()=>n(r.result),r.onerror=()=>e(r.error)})}async function b(t=10){const n=await u();return new Promise((e,o)=>{const d=n.transaction([c],"readonly").objectStore(c).index("timestamp").openCursor(null,"prev"),i=[];d.onsuccess=m=>{const g=m.target.result;g&&i.length<t?(i.push(g.value),g.continue()):e(i)},d.onerror=()=>o(d.error)})}async function C(){const t=await u();return new Promise((n,e)=>{const r=t.transaction([c],"readonly").objectStore(c).count();r.onsuccess=()=>n(r.result),r.onerror=()=>e(r.error)})}async function E(){const t=await u();return new Promise((n,e)=>{const o=t.transaction([c,l],"readwrite"),a=o.objectStore(c),r=o.objectStore(l);a.clear(),r.clear(),o.oncomplete=()=>n(),o.onerror=()=>e(o.error)})}const y="http://localhost:8000";console.log("[Singularity] Background service worker initialized");w().then(()=>{console.log("[Singularity] IndexedDB initialized")}).catch(t=>{console.error("[Singularity] Failed to initialize IndexedDB:",t)});chrome.runtime.onMessage.addListener((t,n,e)=>(v(t).then(e).catch(o=>{console.error("[Singularity] Error handling message:",o),e({error:o.message})}),!0));async function v(t,n){const{action:e}=t;switch(e){case"extractContext":return await j(t.message);case"getRelevantContext":return await B(t.message,t.platform);case"getContextStats":return await F();case"toggleExtension":return await I(t.enabled);case"clearAllContext":return await O();default:return{error:"Unknown action"}}}async function j(t){try{await S(t);const n=await fetch(`${y}/api/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t})});if(!n.ok)throw new Error("Backend extraction failed");const e=await n.json();if(e.facts&&e.facts.length>0){for(const o of e.facts)await h({...o,extractedAt:new Date().toISOString(),sourceMessage:t.text});console.log(`[Singularity] Stored ${e.facts.length} facts`)}return{success:!0,factsExtracted:e.facts.length}}catch(n){console.error("[Singularity] Context extraction failed:",n);const e=k(t);for(const o of e)await h(o);return{success:!0,factsExtracted:e.length,fallback:!0}}}function k(t){const n=[],e=t.text.toLowerCase(),o=[/i (?:like|love|prefer|enjoy) ([^.,!?]+)/gi,/i am (a |an )?([^.,!?]+)/gi,/my (?:favorite|favourite) ([^.,!?]+) is ([^.,!?]+)/gi];for(const a of o){const r=[...e.matchAll(a)];for(const s of r)n.push({text:s[0],category:"preference",confidence:.5,platform:t.platform,timestamp:t.timestamp})}return n}async function B(t,n){try{const e=await fetch(`${y}/api/retrieve`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t,platform:n,limit:5})});if(!e.ok)throw new Error("Backend retrieval failed");return{context:(await e.json()).context||[]}}catch(e){return console.error("[Singularity] Context retrieval failed, using fallback:",e),{context:(await p()).filter(r=>{if(r.platform===n)return!1;const s=t.toLowerCase().split(" "),d=r.text.toLowerCase();return s.some(i=>i.length>3&&d.includes(i))}).slice(0,3).map(r=>r.text)}}}async function F(){try{const t=await C(),n=await b(10);return{count:t,recentFacts:n}}catch(t){return console.error("[Singularity] Failed to get stats:",t),{count:0,recentFacts:[]}}}async function I(t){await chrome.storage.local.set({enabled:t}),console.log(`[Singularity] Extension ${t?"enabled":"disabled"}`);const n=await chrome.tabs.query({});for(const e of n)try{await chrome.tabs.sendMessage(e.id,{action:"toggleExtension",enabled:t})}catch{}return{success:!0}}async function O(){try{return await E(),console.log("[Singularity] All context cleared"),{success:!0}}catch(t){return console.error("[Singularity] Failed to clear context:",t),{success:!1,error:t.message}}}setInterval(async()=>{try{(await fetch(`${y}/health`,{method:"GET"})).ok&&console.log("[Singularity] Backend is healthy")}catch{console.log("[Singularity] Backend is not reachable")}},6e4);
