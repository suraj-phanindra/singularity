const u="Claude",i={inputSelector:'div[contenteditable="true"]',messageContainerSelector:'[data-testid*="message"]',submitButtonSelector:'button[aria-label*="Send"]'};console.log("[Singularity] Content script loaded for Claude.ai");let l=!0,r=0;chrome.storage.local.get(["enabled"],n=>{l=n.enabled!==!1});chrome.runtime.onMessage.addListener((n,o,t)=>{n.action==="toggleExtension"&&(l=n.enabled),t({success:!0})});function d(){const n=setInterval(()=>{const o=document.body;o&&(clearInterval(n),r=document.querySelectorAll(i.messageContainerSelector).length,console.log(`[Singularity] Starting observation with ${r} existing messages`),new MutationObserver(s=>{if(!l)return;const e=document.querySelectorAll(i.messageContainerSelector);console.log(`[Singularity] Mutation detected. Current: ${e.length}, Last: ${r}`),e.length>r&&(console.log(`[Singularity] New messages detected! Processing ${e.length-r} new message(s)`),m(e),r=e.length)}).observe(o,{childList:!0,subtree:!0,attributes:!1,characterData:!1}),console.log("[Singularity] Started observing Claude.ai conversation"))},100);setTimeout(()=>clearInterval(n),1e4)}async function m(n){const o=Array.from(n).slice(r);for(const t of o){const a=t.innerText||t.textContent,s=t.getAttribute("data-testid")==="user-message";if(a&&a.trim().length>0){const e={platform:u,text:a.trim(),isUser:s,timestamp:new Date().toISOString(),url:window.location.href};try{await chrome.runtime.sendMessage({action:"extractContext",message:e}),console.log("[Singularity] Sent message for extraction:",e)}catch(g){console.error("[Singularity] Failed to send message:",g)}}}}function S(){new MutationObserver(()=>{const o=document.querySelector(i.inputSelector),t=document.querySelector(i.submitButtonSelector);o&&t&&!t.dataset.singularityHooked&&(t.dataset.singularityHooked="true",t.addEventListener("click",async a=>{if(!l)return;const s=o.innerText||o.textContent;if(!(!s||s.trim().length===0)){console.log("[Singularity] User is sending:",s);try{const e=await chrome.runtime.sendMessage({action:"getRelevantContext",message:s,platform:u});e&&e.context&&e.context.length>0&&console.log("[Singularity] Found relevant context:",e.context)}catch(e){console.error("[Singularity] Failed to get context:",e)}}},{capture:!0}))}).observe(document.body,{childList:!0,subtree:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c):c();function c(){console.log("[Singularity] Initializing for Claude.ai"),d(),S()}
