const u="Claude",a={inputSelector:'div[contenteditable="true"]',messageContainerSelector:'[data-testid*="message"]',submitButtonSelector:'button[aria-label*="Send"]'};console.log("[Singularity] Content script loaded for Claude.ai");let i=!0,c=0;chrome.storage.local.get(["enabled"],n=>{i=n.enabled!==!1});chrome.runtime.onMessage.addListener((n,o,e)=>{n.action==="toggleExtension"&&(i=n.enabled),e({success:!0})});function g(){new MutationObserver(o=>{if(!i)return;const e=document.querySelectorAll(a.messageContainerSelector);e.length>c&&(m(e),c=e.length)}).observe(document.body,{childList:!0,subtree:!0}),console.log("[Singularity] Started observing Claude.ai conversation")}async function m(n){const o=Array.from(n).slice(c);for(const e of o){const s=e.innerText||e.textContent,r=e.getAttribute("data-testid")==="user-message";if(s&&s.trim().length>0){const t={platform:u,text:s.trim(),isUser:r,timestamp:new Date().toISOString(),url:window.location.href};try{await chrome.runtime.sendMessage({action:"extractContext",message:t}),console.log("[Singularity] Sent message for extraction:",t)}catch(d){console.error("[Singularity] Failed to send message:",d)}}}}function b(){new MutationObserver(()=>{const o=document.querySelector(a.inputSelector),e=document.querySelector(a.submitButtonSelector);o&&e&&!e.dataset.singularityHooked&&(e.dataset.singularityHooked="true",e.addEventListener("click",async s=>{if(!i)return;const r=o.innerText||o.textContent;if(!(!r||r.trim().length===0)){console.log("[Singularity] User is sending:",r);try{const t=await chrome.runtime.sendMessage({action:"getRelevantContext",message:r,platform:u});t&&t.context&&t.context.length>0&&console.log("[Singularity] Found relevant context:",t.context)}catch(t){console.error("[Singularity] Failed to get context:",t)}}},{capture:!0}))}).observe(document.body,{childList:!0,subtree:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",l):l();function l(){console.log("[Singularity] Initializing for Claude.ai"),g(),b()}
