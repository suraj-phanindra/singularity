const d="ChatGPT",l={name:"ChatGPT",inputSelector:"#prompt-textarea",messageContainerSelector:"div[data-message-author-role]",userMessageSelector:'div[data-message-author-role="user"]',assistantMessageSelector:'div[data-message-author-role="assistant"]',submitButtonSelector:'button[data-testid="send-button"]'};console.log("[Singularity] Content script loaded for ChatGPT");let a=!0,u=0;chrome.storage.local.get(["enabled"],t=>{a=t.enabled!==!1});chrome.runtime.onMessage.addListener((t,i,s)=>{t.action==="toggleExtension"&&(a=t.enabled),s({success:!0})});function f(){new MutationObserver(i=>{if(!a)return;const s=document.querySelectorAll(l.messageContainerSelector);s.length>u&&(p(s),u=s.length)}).observe(document.body,{childList:!0,subtree:!0}),console.log("[Singularity] Started observing ChatGPT conversation")}async function p(t){const i=Array.from(t).slice(u);for(const s of i){const o=s.getAttribute("data-message-author-role"),e=s.innerText||s.textContent;if(e&&e.trim().length>0){const n={platform:d,text:e.trim(),isUser:o==="user",timestamp:new Date().toISOString(),url:window.location.href};try{await chrome.runtime.sendMessage({action:"extractContext",message:n}),console.log("[Singularity] Sent message for extraction:",n)}catch(r){console.error("[Singularity] Failed to send message:",r)}}}}function b(){let t=!1;const i=async o=>{if(console.log("[Singularity] interceptSubmit called, enabled:",a,"processing:",t),!a||t)return;const e=document.querySelector(l.inputSelector);if(console.log("[Singularity] Input field found:",!!e),!e)return;const n=e.value||e.textContent;if(console.log("[Singularity] User message:",n),!(!n||n.trim().length===0)&&!n.includes("[Context from other AI conversations:")){console.log("[Singularity] Intercepting ChatGPT message:",n),t=!0;try{const r=await chrome.runtime.sendMessage({action:"getRelevantContext",message:n,platform:d});if(console.log("[Singularity] Got response:",r),r&&r.context&&r.context.length>0){console.log("[Singularity] Injecting context:",r.context),o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();const m=`[Context from other AI conversations: ${r.context.join("; ")}]

`+n;e.textContent="",e.innerText=m,e.focus(),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),setTimeout(()=>{t=!1;const c=document.querySelector(l.submitButtonSelector);c&&!c.disabled&&c.click()},500)}else t=!1,console.log("[Singularity] No context to inject")}catch(r){t=!1,console.error("[Singularity] Failed to inject context:",r)}}};new MutationObserver(()=>{const o=document.querySelector(l.inputSelector);o&&!o.dataset.singularityHooked&&(o.dataset.singularityHooked="true",o.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey&&!t){const n=o.value||o.textContent;if(!n||n.includes("[Context from other AI conversations:"))return;console.log("[Singularity] Blocking Enter, will enhance and resubmit"),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),i(e)}},!0),console.log("[Singularity] Hooked ChatGPT input field"))}).observe(document.body,{childList:!0,subtree:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();function g(){console.log("[Singularity] Initializing for ChatGPT"),f(),b()}
