const p="ChatGPT",a={name:"ChatGPT",inputSelector:"#prompt-textarea",messageContainerSelector:"div[data-message-author-role]",userMessageSelector:'div[data-message-author-role="user"]',assistantMessageSelector:'div[data-message-author-role="assistant"]',submitButtonSelector:'button[data-testid="send-button"]'};console.log("[Singularity] Content script loaded for ChatGPT");let l=!0,d=0;chrome.storage.local.get(["enabled"],o=>{l=o.enabled!==!1});chrome.runtime.onMessage.addListener((o,c,i)=>{o.action==="toggleExtension"&&(l=o.enabled),i({success:!0})});function f(){new MutationObserver(c=>{if(!l)return;const i=document.querySelectorAll(a.messageContainerSelector);i.length>d&&(b(i),d=i.length)}).observe(document.body,{childList:!0,subtree:!0}),console.log("[Singularity] Started observing ChatGPT conversation")}async function b(o){const c=Array.from(o).slice(d);for(const i of c){const t=i.getAttribute("data-message-author-role");let e=i.innerText||i.textContent;if(e&&e.trim().length>0){const n=/^\[Context from other AI conversations:[^\]]+\]\s*/,s=e.replace(n,"");if(s.trim().length===0){console.log("[Singularity] Skipping message that only contains injected context");continue}const r={platform:p,text:s.trim(),isUser:t==="user",timestamp:new Date().toISOString(),url:window.location.href};try{await chrome.runtime.sendMessage({action:"extractContext",message:r}),console.log("[Singularity] Sent message for extraction (context stripped):",r)}catch(u){console.error("[Singularity] Failed to send message:",u)}}}}function S(){let o=!1;const c=async t=>{if(console.log("[Singularity] interceptSubmit called, enabled:",l,"processing:",o),!l||o)return;const e=document.querySelector(a.inputSelector);if(console.log("[Singularity] Input field found:",!!e),!e)return;const n=e.value||e.textContent;if(console.log("[Singularity] User message:",n),!(!n||n.trim().length===0)&&!n.includes("[Context from other AI conversations:")){console.log("[Singularity] Intercepting ChatGPT message:",n),o=!0;try{const s=await chrome.runtime.sendMessage({action:"getRelevantContext",message:n,platform:p});if(console.log("[Singularity] Got response:",s),s&&s.context&&s.context.length>0){console.log("[Singularity] Injecting context:",s.context),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const u=`[Context from other AI conversations: ${s.context.join("; ")}]

`+n;e.textContent="",e.innerText=u,e.focus(),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),setTimeout(()=>{o=!1;const g=document.querySelector(a.submitButtonSelector);g&&!g.disabled&&g.click()},500)}else console.log("[Singularity] No context to inject, sending original message"),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),setTimeout(()=>{o=!1;const r=document.querySelector(a.submitButtonSelector);r&&!r.disabled&&r.click()},100)}catch(s){console.error("[Singularity] Failed to inject context:",s),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),setTimeout(()=>{o=!1;const r=document.querySelector(a.submitButtonSelector);r&&!r.disabled&&r.click()},100)}}};new MutationObserver(()=>{const t=document.querySelector(a.inputSelector);t&&!t.dataset.singularityHooked&&(t.dataset.singularityHooked="true",t.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey&&!o){const n=t.value||t.textContent;if(!n||n.includes("[Context from other AI conversations:"))return;console.log("[Singularity] Blocking Enter, will enhance and resubmit"),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),c(e)}},!0),console.log("[Singularity] Hooked ChatGPT input field"))}).observe(document.body,{childList:!0,subtree:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m):m();function m(){console.log("[Singularity] Initializing for ChatGPT"),f(),S()}
