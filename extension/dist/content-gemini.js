const l="Gemini";console.log("[Singularity] Content script loaded for Gemini");let a=!0,i=0;chrome.storage.local.get(["enabled"],e=>{a=e.enabled!==!1});chrome.runtime.onMessage.addListener((e,n,t)=>{e.action==="toggleExtension"&&(a=e.enabled),t({success:!0})});function g(){new MutationObserver(n=>{if(!a)return;const t=m();t.length>i&&(f(t),i=t.length)}).observe(document.body,{childList:!0,subtree:!0}),console.log("[Singularity] Started observing Gemini conversation")}function m(){const e=["message-content",'[class*="message"]','[data-test-id*="message"]',".model-response-text",".user-query"];for(const n of e){const t=document.querySelectorAll(n);if(t.length>0)return t}return[]}async function f(e){const n=Array.from(e).slice(i);for(const t of n){const s=t.innerText||t.textContent,r=b(t);if(s&&s.trim().length>0){const o={platform:l,text:s.trim(),isUser:r,timestamp:new Date().toISOString(),url:window.location.href};try{await chrome.runtime.sendMessage({action:"extractContext",message:o}),console.log("[Singularity] Sent message for extraction:",o)}catch(c){console.error("[Singularity] Failed to send message:",c)}}}}function b(e){const n=e.className||"",t=e.dataset||{};if(n.includes("user")||t.role==="user")return!0;let s=e.parentElement;for(;s&&s!==document.body;){const r=s.className||"";if(r.includes("user-query")||r.includes("user-message"))return!0;if(r.includes("model-response")||r.includes("assistant"))return!1;s=s.parentElement}return!1}function x(){new MutationObserver(()=>{const n=y(),t=h();n&&t&&!t.dataset.singularityHooked&&(t.dataset.singularityHooked="true",t.addEventListener("click",async s=>{if(!a)return;const r=v(n);if(!(!r||r.trim().length===0)){console.log("[Singularity] User is sending:",r);try{const o=await chrome.runtime.sendMessage({action:"getRelevantContext",message:r,platform:l});if(o&&o.context&&o.context.length>0){console.log("[Singularity] Injecting context:",o.context),s.preventDefault(),s.stopPropagation();const d=`[Context from other AI conversations: ${o.context.join("; ")}]

`+r;p(n,d),setTimeout(()=>{t.click()},100)}}catch(o){console.error("[Singularity] Failed to inject context:",o)}}},{capture:!0,once:!0}))}).observe(document.body,{childList:!0,subtree:!0})}function y(){const e=['div[contenteditable="true"]','textarea[placeholder*="Enter"]',"rich-textarea",'[data-test-id*="input"]'];for(const n of e){const t=document.querySelector(n);if(t)return t}return null}function h(){const e=['button[aria-label*="Send"]','button[aria-label*="Submit"]','button[type="submit"]','[data-test-id*="send"]'];for(const n of e){const t=document.querySelector(n);if(t&&!t.disabled)return t}return null}function v(e){return e.tagName==="TEXTAREA"?e.value:e.contentEditable==="true"?e.innerText||e.textContent:""}function p(e,n){e.tagName==="TEXTAREA"?e.value=n:e.contentEditable==="true"&&(e.textContent=n),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();function u(){console.log("[Singularity] Initializing for Gemini"),g(),x()}
