const d="Gemini";console.log("[Singularity] Content script loaded for Gemini");let a=!0,l=0;chrome.storage.local.get(["enabled"],t=>{a=t.enabled!==!1});chrome.runtime.onMessage.addListener((t,n,e)=>{t.action==="toggleExtension"&&(a=t.enabled),e({success:!0})});function m(){new MutationObserver(n=>{if(!a)return;const e=f();e.length>l&&(b(e),l=e.length)}).observe(document.body,{childList:!0,subtree:!0}),console.log("[Singularity] Started observing Gemini conversation")}function f(){const t=["message-content",'[class*="message"]','[data-test-id*="message"]',".model-response-text",".user-query"];for(const n of t){const e=document.querySelectorAll(n);if(e.length>0)return e}return[]}async function b(t){const n=Array.from(t).slice(l);for(const e of n){let o=e.innerText||e.textContent;const s=x(e);if(o&&o.trim().length>0){const r=/^\[Context from other AI conversations:[^\]]+\]\s*/,c=o.replace(r,"");if(c.trim().length===0){console.log("[Singularity] Skipping message that only contains injected context");continue}const i={platform:d,text:c.trim(),isUser:s,timestamp:new Date().toISOString(),url:window.location.href};try{await chrome.runtime.sendMessage({action:"extractContext",message:i}),console.log("[Singularity] Sent message for extraction (context stripped):",i)}catch(g){console.error("[Singularity] Failed to send message:",g)}}}}function x(t){const n=t.className||"",e=t.dataset||{};if(n.includes("user")||e.role==="user")return!0;let o=t.parentElement;for(;o&&o!==document.body;){const s=o.className||"";if(s.includes("user-query")||s.includes("user-message"))return!0;if(s.includes("model-response")||s.includes("assistant"))return!1;o=o.parentElement}return!1}function y(){new MutationObserver(()=>{const n=h(),e=p();n&&e&&!e.dataset.singularityHooked&&(e.dataset.singularityHooked="true",e.addEventListener("click",async o=>{if(!a)return;const s=v(n);if(!(!s||s.trim().length===0)){if(s.includes("[Context from other AI conversations:")){delete e.dataset.singularityHooked;return}console.log("[Singularity] User is sending:",s),o.preventDefault(),o.stopPropagation();try{const r=await chrome.runtime.sendMessage({action:"getRelevantContext",message:s,platform:d});if(r&&r.context&&r.context.length>0){console.log("[Singularity] Injecting context:",r.context);const i=`[Context from other AI conversations: ${r.context.join("; ")}]

`+s;S(n,i),delete e.dataset.singularityHooked,setTimeout(()=>{e.click()},100)}else console.log("[Singularity] No context to inject, sending original message"),delete e.dataset.singularityHooked,setTimeout(()=>{e.click()},100)}catch(r){console.error("[Singularity] Failed to inject context:",r),delete e.dataset.singularityHooked,setTimeout(()=>{e.click()},100)}}},{capture:!0,once:!0}))}).observe(document.body,{childList:!0,subtree:!0})}function h(){const t=['div[contenteditable="true"]','textarea[placeholder*="Enter"]',"rich-textarea",'[data-test-id*="input"]'];for(const n of t){const e=document.querySelector(n);if(e)return e}return null}function p(){const t=['button[aria-label*="Send"]','button[aria-label*="Submit"]','button[type="submit"]','[data-test-id*="send"]'];for(const n of t){const e=document.querySelector(n);if(e&&!e.disabled)return e}return null}function v(t){return t.tagName==="TEXTAREA"?t.value:t.contentEditable==="true"?t.innerText||t.textContent:""}function S(t,n){t.tagName==="TEXTAREA"?t.value=n:t.contentEditable==="true"&&(t.textContent=n),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();function u(){console.log("[Singularity] Initializing for Gemini"),m(),y()}
